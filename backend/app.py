#!/usr/bin/env python3
"""
DevAssist Pro - –ú–æ–Ω–æ–ª–∏—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ –æ–¥–Ω–æ–º FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –∑–∞–ø—É—Å–∫–∞
"""
import os
import logging
import sys
import asyncio
from typing import Dict, Any, List, Optional
from datetime import datetime
from pathlib import Path

# FastAPI –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
from fastapi import FastAPI, HTTPException, Depends, BackgroundTasks, Query, UploadFile, File
from fastapi.responses import JSONResponse, FileResponse
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import uvicorn

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ shared –º–æ–¥—É–ª—è–º
sys.path.append(str(Path(__file__).parent / "shared"))

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ========================================
# –°–•–ï–ú–´ –ò –ú–û–î–ï–õ–ò
# ========================================

class HealthResponse(BaseModel):
    status: str
    service: str
    timestamp: str
    version: str = "1.0.0"

class AnalyticsRequest(BaseModel):
    data_type: str
    aggregation_type: str = "count"
    period: str = "30d"
    filters: Optional[Dict[str, Any]] = {}

class AnalyticsResponse(BaseModel):
    data_type: str
    results: Dict[str, Any]
    metadata: Dict[str, Any]

class ReportGenerationRequest(BaseModel):
    analysis_id: int
    report_format: str = "pdf"
    template_name: str = "kp_analysis_default"
    include_charts: bool = True
    include_raw_data: bool = False

class ReportGenerationResponse(BaseModel):
    report_id: str
    analysis_id: int
    format: str
    status: str
    download_url: Optional[str] = None
    generated_at: str

class DashboardStats(BaseModel):
    overview: Dict[str, Any]
    charts: List[Dict[str, Any]]
    metrics: Dict[str, Any]

# ========================================
# –ë–ò–ó–ù–ï–°-–õ–û–ì–ò–ö–ê
# ========================================

class ReportsManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç—á–µ—Ç–æ–≤"""
    
    def __init__(self):
        self.reports_dir = Path("data/reports")
        self.reports_dir.mkdir(exist_ok=True)
    
    async def generate_pdf_report(self, analysis_id: int, template_name: str = "default") -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –æ—Ç—á–µ—Ç–∞"""
        filename = f"kp_analysis_{analysis_id}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"
        filepath = self.reports_dir / filename
        
        # –ú–æ–∫-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è PDF
        pdf_content = f"""
        –ö–ü –ê–ù–ê–õ–ò–ó –û–¢–ß–ï–¢ #{analysis_id}
        =============================
        
        –î–∞—Ç–∞: {datetime.now().strftime('%d.%m.%Y %H:%M')}
        –®–∞–±–ª–æ–Ω: {template_name}
        
        –û–°–ù–û–í–ù–´–ï –ú–ï–¢–†–ò–ö–ò:
        - –ö–∞—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: 85%
        - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º: 92%
        - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: 78%
        
        –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
        - –£—Ç–æ—á–Ω–∏—Ç—å —Å—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        - –î–æ–±–∞–≤–∏—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞
        - –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ü–µ–Ω–æ–≤—É—é –ø–æ–ª–∏—Ç–∏–∫—É
        
        –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:
        –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º,
        —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—é —Å —É—á–µ—Ç–æ–º –∑–∞–º–µ—á–∞–Ω–∏–π.
        """
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(pdf_content)
        
        logger.info(f"PDF –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: {filename}")
        return filename
    
    async def generate_excel_report(self, analysis_id: int) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel –æ—Ç—á–µ—Ç–∞"""
        filename = f"kp_data_{analysis_id}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
        filepath = self.reports_dir / filename
        
        # –ú–æ–∫-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è Excel
        excel_content = f"""
        –õ–∏—Å—Ç 1: –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        ID –ê–Ω–∞–ª–∏–∑–∞: {analysis_id}
        –î–∞—Ç–∞: {datetime.now()}
        
        –õ–∏—Å—Ç 2: –ú–µ—Ç—Ä–∏–∫–∏
        –ö–∞—á–µ—Å—Ç–≤–æ: 85%
        –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: 92%
        –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å: 78%
        
        –õ–∏—Å—Ç 3: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        1. –£—Ç–æ—á–Ω–∏—Ç—å —Å—Ä–æ–∫–∏
        2. –î–æ–±–∞–≤–∏—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏–∏
        3. –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ü–µ–Ω—ã
        """
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(excel_content)
        
        logger.info(f"Excel –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: {filename}")
        return filename

class AnalyticsManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏"""
    
    def __init__(self):
        self.cache = {}
    
    async def process_analytics(self, data_type: str, aggregation_type: str = "count") -> Dict[str, Any]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö"""
        
        # –ú–æ–∫-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        mock_data = {
            "analyses": {
                "total_analyses": 1247,
                "successful_analyses": 1156,
                "failed_analyses": 91,
                "success_rate": 92.7,
                "avg_processing_time": 23.5,
                "total_cost": 1847.50
            },
            "documents": {
                "total_documents": 2394,
                "processed_documents": 2201,
                "pdf_documents": 1456,
                "docx_documents": 789,
                "txt_documents": 149,
                "avg_file_size": 2.3
            },
            "users": {
                "total_users": 89,
                "active_users": 67,
                "new_users": 12,
                "avg_session_duration": 45.2
            },
            "projects": {
                "total_projects": 234,
                "active_projects": 89,
                "completed_projects": 134,
                "avg_project_duration": 12.5
            }
        }
        
        return mock_data.get(data_type, {})
    
    async def calculate_metrics(self, metric_types: List[str], period: str = "30d") -> Dict[str, Any]:
        """–†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫"""
        
        metrics = {}
        
        for metric_type in metric_types:
            if metric_type == "success_rate":
                metrics[metric_type] = {
                    "value": 92.7,
                    "unit": "%",
                    "trend": "+2.3",
                    "period": period
                }
            elif metric_type == "avg_processing_time":
                metrics[metric_type] = {
                    "value": 23.5,
                    "unit": "—Å–µ–∫",
                    "trend": "-1.2",
                    "period": period
                }
            elif metric_type == "cost_per_analysis":
                metrics[metric_type] = {
                    "value": 1.48,
                    "unit": "$",
                    "trend": "-0.15",
                    "period": period
                }
        
        return metrics
    
    async def generate_dashboard_stats(self, period: str = "30d") -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞"""
        
        return {
            "overview": {
                "total_projects": 234,
                "total_analyses": 1247,
                "total_documents": 2394,
                "total_users": 89,
                "success_rate": 92.7,
                "avg_processing_time": 23.5
            },
            "charts": [
                {
                    "type": "line",
                    "title": "–ê–Ω–∞–ª–∏–∑—ã –ø–æ –¥–Ω—è–º",
                    "data": [45, 52, 38, 41, 59, 67, 48]
                },
                {
                    "type": "pie", 
                    "title": "–¢–∏–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤",
                    "data": {"PDF": 61, "DOCX": 33, "TXT": 6}
                },
                {
                    "type": "bar",
                    "title": "–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º",
                    "data": [89, 92, 87, 94, 91]
                }
            ],
            "metrics": {
                "period": period,
                "generated_at": datetime.now().isoformat(),
                "total_cost": 1847.50,
                "avg_cost_per_analysis": 1.48
            }
        }

class DocumentsManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
    
    def __init__(self):
        self.uploads_dir = Path("data/uploads")
        self.uploads_dir.mkdir(exist_ok=True)
    
    async def upload_file(self, file: UploadFile) -> Dict[str, Any]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞"""
        filename = f"{datetime.now().strftime('%Y%m%d_%H%M%S')}_{file.filename}"
        filepath = self.uploads_dir / filename
        
        content = await file.read()
        with open(filepath, 'wb') as f:
            f.write(content)
        
        return {
            "document_id": hash(filename) % 100000,
            "filename": filename,
            "original_name": file.filename,
            "size": len(content),
            "content_type": file.content_type,
            "uploaded_at": datetime.now().isoformat()
        }
    
    async def analyze_document(self, document_id: int) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        
        # –ú–æ–∫-–∞–Ω–∞–ª–∏–∑ –ö–ü
        return {
            "analysis_id": document_id * 10,
            "document_id": document_id,
            "status": "completed",
            "analysis_type": "kp_analysis",
            "results": {
                "quality_score": 85.2,
                "compliance_score": 92.1,
                "competitiveness_score": 78.5,
                "summary": "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Å –∑–∞–º–µ—á–∞–Ω–∏—è–º–∏",
                "recommendations": [
                    "–£—Ç–æ—á–Ω–∏—Ç—å —Å—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç",
                    "–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞—Ö",
                    "–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ü–µ–Ω–æ–≤—É—é –ø–æ–ª–∏—Ç–∏–∫—É –≤ —Å—Ç–æ—Ä–æ–Ω—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏"
                ],
                "key_points": [
                    "–ß–µ—Ç–∫–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω—ã —Ü–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞",
                    "–£–∫–∞–∑–∞–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ —ç—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è",
                    "–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
                    "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ä–∏—Å–∫–∏"
                ]
            },
            "processed_at": datetime.now().isoformat(),
            "processing_time": 23.7,
            "ai_provider": "openai",
            "model_used": "gpt-4"
        }

# ========================================
# –°–û–ó–î–ê–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ========================================

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
reports_manager = ReportsManager()
analytics_manager = AnalyticsManager()
documents_manager = DocumentsManager()

# –°–æ–∑–¥–∞–Ω–∏–µ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
app = FastAPI(
    title="DevAssist Pro - –ö–ü –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä",
    description="–ú–æ–Ω–æ–ª–∏—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π",
    version="1.0.0"
)

# CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ========================================
# HEALTH CHECK
# ========================================

@app.get("/health", response_model=HealthResponse)
async def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞"""
    return HealthResponse(
        status="healthy",
        service="devassist-pro-monolith",
        timestamp=datetime.now().isoformat()
    )

# ========================================
# DOCUMENTS API
# ========================================

@app.post("/api/documents/upload")
async def upload_document(file: UploadFile = File(...)):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
    try:
        result = await documents_manager.upload_file(file)
        return {"success": True, "data": result}
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/documents/{document_id}/analyze")
async def analyze_document(document_id: int):
    """–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
    try:
        result = await documents_manager.analyze_document(document_id)
        return {"success": True, "data": result}
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {e}")
        raise HTTPException(status_code=500, detail=str(e))

# ========================================
# ANALYTICS API
# ========================================

@app.post("/api/analytics/process", response_model=AnalyticsResponse)
async def process_analytics(request: AnalyticsRequest):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö"""
    try:
        results = await analytics_manager.process_analytics(
            request.data_type, 
            request.aggregation_type
        )
        
        return AnalyticsResponse(
            data_type=request.data_type,
            results=results,
            metadata={
                "period": request.period,
                "processed_at": datetime.now().isoformat(),
                "aggregation_type": request.aggregation_type
            }
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/analytics/dashboard")
async def get_dashboard_stats(period: str = Query("30d")):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞"""
    try:
        stats = await analytics_manager.generate_dashboard_stats(period)
        return {"success": True, "data": stats}
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/analytics/metrics")
async def calculate_metrics(
    metric_types: List[str],
    period: str = Query("30d")
):
    """–†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫"""
    try:
        metrics = await analytics_manager.calculate_metrics(metric_types, period)
        return {"success": True, "data": metrics}
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫: {e}")
        raise HTTPException(status_code=500, detail=str(e))

# ========================================
# REPORTS API
# ========================================

@app.post("/api/reports/generate/pdf", response_model=ReportGenerationResponse)
async def generate_pdf_report(request: ReportGenerationRequest):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –æ—Ç—á–µ—Ç–∞"""
    try:
        filename = await reports_manager.generate_pdf_report(
            request.analysis_id, 
            request.template_name
        )
        
        return ReportGenerationResponse(
            report_id=f"pdf_{request.analysis_id}_{int(datetime.now().timestamp())}",
            analysis_id=request.analysis_id,
            format="pdf",
            status="completed",
            download_url=f"/api/reports/download/pdf/{filename}",
            generated_at=datetime.now().isoformat()
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/reports/generate/excel", response_model=ReportGenerationResponse)
async def generate_excel_report(request: ReportGenerationRequest):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel –æ—Ç—á–µ—Ç–∞"""
    try:
        filename = await reports_manager.generate_excel_report(request.analysis_id)
        
        return ReportGenerationResponse(
            report_id=f"excel_{request.analysis_id}_{int(datetime.now().timestamp())}",
            analysis_id=request.analysis_id,
            format="excel",
            status="completed",
            download_url=f"/api/reports/download/excel/{filename}",
            generated_at=datetime.now().isoformat()
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Excel: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/reports/download/pdf/{filename}")
async def download_pdf_report(filename: str):
    """–°–∫–∞—á–∏–≤–∞–Ω–∏–µ PDF –æ—Ç—á–µ—Ç–∞"""
    filepath = reports_manager.reports_dir / filename
    if not filepath.exists():
        raise HTTPException(status_code=404, detail="–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    return FileResponse(
        path=filepath,
        filename=filename,
        media_type="application/pdf"
    )

@app.get("/api/reports/download/excel/{filename}")
async def download_excel_report(filename: str):
    """–°–∫–∞—á–∏–≤–∞–Ω–∏–µ Excel –æ—Ç—á–µ—Ç–∞"""
    filepath = reports_manager.reports_dir / filename
    if not filepath.exists():
        raise HTTPException(status_code=404, detail="–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    return FileResponse(
        path=filepath,
        filename=filename,
        media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )

# ========================================
# –ö–ü –ê–ù–ê–õ–ò–ó–ê–¢–û–† API (–û–°–ù–û–í–ù–û–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ)
# ========================================

@app.post("/api/kp-analyzer/full-analysis")
async def full_kp_analysis(file: UploadFile = File(...)):
    """–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ö–ü: –∑–∞–≥—Ä—É–∑–∫–∞ ‚Üí –∞–Ω–∞–ª–∏–∑ ‚Üí –æ—Ç—á–µ—Ç"""
    try:
        # 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        upload_result = await documents_manager.upload_file(file)
        document_id = upload_result["document_id"]
        
        # 2. –ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        analysis_result = await documents_manager.analyze_document(document_id)
        analysis_id = analysis_result["analysis_id"]
        
        # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
        pdf_filename = await reports_manager.generate_pdf_report(analysis_id)
        excel_filename = await reports_manager.generate_excel_report(analysis_id)
        
        return {
            "success": True,
            "data": {
                "document": upload_result,
                "analysis": analysis_result,
                "reports": {
                    "pdf": {
                        "filename": pdf_filename,
                        "download_url": f"/api/reports/download/pdf/{pdf_filename}"
                    },
                    "excel": {
                        "filename": excel_filename,
                        "download_url": f"/api/reports/download/excel/{excel_filename}"
                    }
                }
            }
        }
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ö–ü: {e}")
        raise HTTPException(status_code=500, detail=str(e))

# ========================================
# –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–ï ENDPOINTS
# ========================================

@app.get("/api/admin/status")
async def get_system_status():
    """–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã"""
    return {
        "status": "operational",
        "version": "1.0.0",
        "services": {
            "documents": "healthy",
            "analytics": "healthy", 
            "reports": "healthy"
        },
        "uptime": "running",
        "timestamp": datetime.now().isoformat()
    }

@app.get("/api/admin/stats")
async def get_system_stats():
    """–°–∏—Å—Ç–µ–º–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"""
    try:
        stats = await analytics_manager.generate_dashboard_stats()
        return {"success": True, "data": stats}
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
        raise HTTPException(status_code=500, detail=str(e))

# ========================================
# –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ========================================

if __name__ == "__main__":
    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    os.makedirs("data/reports", exist_ok=True)
    os.makedirs("data/uploads", exist_ok=True)
    
    print("üöÄ –ó–∞–ø—É—Å–∫ DevAssist Pro - –ú–æ–Ω–æ–ª–∏—Ç–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ")
    print("=" * 50)
    print("üìä –î–æ—Å—Ç—É–ø–Ω—ã–µ API:")
    print("   ‚Ä¢ Health Check:     http://localhost:8000/health")
    print("   ‚Ä¢ API Docs:         http://localhost:8000/docs")
    print("   ‚Ä¢ Documents API:    http://localhost:8000/api/documents/")
    print("   ‚Ä¢ Analytics API:    http://localhost:8000/api/analytics/")
    print("   ‚Ä¢ Reports API:      http://localhost:8000/api/reports/")
    print("   ‚Ä¢ –ö–ü Analyzer:      http://localhost:8000/api/kp-analyzer/")
    print("   ‚Ä¢ Admin Panel:      http://localhost:8000/api/admin/")
    print("=" * 50)
    
    uvicorn.run(
        "app:app",
        host="0.0.0.0",
        port=8000,
        reload=True,
        log_level="info"
    )